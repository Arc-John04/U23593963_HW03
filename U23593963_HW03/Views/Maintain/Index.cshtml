@model U23593963_HW03.Models.HomeViewModel
@{
    ViewBag.Title = "Maintain";
}

<style>
    .maintain-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .maintain-box {
        border: 2px solid #ccc;
        padding: 15px;
        flex: 1;
        background: #f9f9f9;
        border-radius: 5px;
    }

        .maintain-box h4 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

    .form-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

        .form-row label {
            flex: 0 0 120px;
            font-weight: bold;
            margin: 0;
        }

        .form-row input,
        .form-row select {
            flex: 1;
        }

    .list-area {
        border: 1px solid #999;
        background: #fff;
        padding: 10px;
        height: 150px;
        overflow-y: auto;
        margin-top: 10px;
    }

        .list-area ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-area li {
            cursor: pointer;
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
        }

            .list-area li:hover {
                background: #f0f0f0;
            }

            .list-area li.selected {
                background: #e3f2fd;
            }

    .action-buttons {
        margin-top: 15px;
        display: flex;
        gap: 8px;
    }

    .product-section {
        display: flex;
        gap: 15px;
    }

    .product-details {
        flex: 1;
    }

    .product-image {
        width: 150px;
        height: 150px;
        border: 1px solid #999;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

    .placeholder-text {
        color: #999;
        font-style: italic;
    }

    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
</style>

<h2>Maintain</h2>

<!-- Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

<div class="maintain-container">

    <!-- STAFF SECTION -->
    <div class="maintain-box">
        <h4>Staff List</h4>

        <div class="form-row">
            <label>First Name:</label>
            <input type="text" id="staff_first" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Last Name:</label>
            <input type="text" id="staff_last" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Staff ID:</label>
            <input type="text" id="staff_id" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Email:</label>
            <input type="text" id="staff_email" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Phone:</label>
            <input type="text" id="staff_phone" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Store:</label>
            <input type="text" id="staff_store" class="form-control form-control-sm" readonly />
        </div>

        <div class="list-area">
            <ul id="staffList">
                @foreach (var s in Model.Staffs)
                {
                    <li data-id="@s.staff_id">@s.first_name @s.last_name - @(s.stores?.store_name ?? "N/A")</li>
                }
            </ul>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary btn-sm" id="editStaffBtn">Edit</button>
            <button class="btn btn-success btn-sm" id="updateStaffBtn" style="display:none;">Update</button>
            <button class="btn btn-secondary btn-sm" id="cancelStaffBtn" style="display:none;">Cancel</button>
            <button class="btn btn-danger btn-sm" id="deleteStaffBtn">Delete</button>
        </div>
    </div>

    <!-- CUSTOMERS SECTION -->
    <div class="maintain-box">
        <h4>Customer List</h4>

        <div class="form-row">
            <label>First Name:</label>
            <input type="text" id="cust_first" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Last Name:</label>
            <input type="text" id="cust_last" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Customer ID:</label>
            <input type="text" id="cust_id" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Email:</label>
            <input type="text" id="cust_email" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>Phone:</label>
            <input type="text" id="cust_phone" class="form-control form-control-sm" readonly />
        </div>
        <div class="form-row">
            <label>City:</label>
            <input type="text" id="cust_city" class="form-control form-control-sm" readonly />
        </div>

        <div class="list-area">
            <ul id="customerList">
                @foreach (var c in Model.Customers)
                {
                    <li data-id="@c.customer_id">@c.first_name @c.last_name - @(c.city ?? "N/A")</li>
                }
            </ul>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary btn-sm" id="editCustomerBtn">Edit</button>
            <button class="btn btn-success btn-sm" id="updateCustomerBtn" style="display:none;">Update</button>
            <button class="btn btn-secondary btn-sm" id="cancelCustomerBtn" style="display:none;">Cancel</button>
            <button class="btn btn-danger btn-sm" id="deleteCustomerBtn">Delete</button>
        </div>
    </div>

    <!-- PRODUCTS SECTION -->
    <div class="maintain-box">
        <h4>Product List</h4>

        <div class="product-section">
            <div class="product-details">
                <div class="form-row">
                    <label>Product Name:</label>
                    <input type="text" id="product_name" class="form-control form-control-sm" readonly />
                </div>
                <div class="form-row">
                    <label>Brand:</label>
                    <input type="text" id="product_brand" class="form-control form-control-sm" readonly />
                </div>
                <div class="form-row">
                    <label>Category:</label>
                    <input type="text" id="product_category" class="form-control form-control-sm" readonly />
                </div>
                <div class="form-row">
                    <label>Model Year:</label>
                    <input type="text" id="product_year" class="form-control form-control-sm" readonly />
                </div>
                <div class="form-row">
                    <label>Price:</label>
                    <input type="text" id="product_price" class="form-control form-control-sm" readonly />
                </div>

                <div class="list-area">
                    <ul id="productList">
                        @foreach (var p in Model.Products)
                        {
                            <li data-id="@p.product_id">@p.product_name - $@p.list_price</li>
                        }
                    </ul>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary btn-sm" id="editProductBtn">Edit</button>
                    <button class="btn btn-success btn-sm" id="updateProductBtn" style="display:none;">Update</button>
                    <button class="btn btn-secondary btn-sm" id="cancelProductBtn" style="display:none;">Cancel</button>
                    <button class="btn btn-danger btn-sm" id="deleteProductBtn">Delete</button>
                </div>
            </div>

            <div class="product-image" id="productImageContainer">
                <span class="placeholder-text">Select a product</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Staff Edit -->
<div class="modal fade" id="staffEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("UpdateStaff", "Maintain", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" id="modal_staff_id" name="staff_id" />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Staff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="modal_staff_first_name" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="modal_staff_last_name" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="modal_staff_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="modal_staff_phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Active</label>
                        <select class="form-select" id="modal_staff_active" name="active">
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Store *</label>
                        <select class="form-select" id="modal_staff_store" name="store_id" required>
                            @if (ViewBag.Stores != null)
                            {
                                foreach (var store in ViewBag.Stores)
                                {
                                    <option value="@store.store_id">@store.store_name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Manager</label>
                        <select class="form-select" id="modal_staff_manager" name="manager_id">
                            <option value="">No Manager</option>
                            @if (Model != null && Model.Staffs != null)
                            {
                                foreach (var staff in Model.Staffs)
                                {
                                    <option value="@staff.staff_id">@staff.first_name @staff.last_name</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for Customer Edit -->
<div class="modal fade" id="customerEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("UpdateCustomer", "Maintain", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" id="modal_customer_id" name="customer_id" />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="modal_customer_first_name" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="modal_customer_last_name" name="last_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" id="modal_customer_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="modal_customer_phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Street</label>
                        <input type="text" class="form-control" id="modal_customer_street" name="street">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" id="modal_customer_city" name="city">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">State</label>
                        <input type="text" class="form-control" id="modal_customer_state" name="state">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Zip Code</label>
                        <input type="text" class="form-control" id="modal_customer_zip" name="zip_code" maxlength="5">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal for Product Edit -->
<div class="modal fade" id="productEditModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("UpdateProduct", "Maintain", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <input type="hidden" id="modal_product_id" name="product_id" />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="modal_product_name" name="product_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brand *</label>
                        <select class="form-select" id="modal_product_brand" name="brand_id" required>
                            @if (ViewBag.Brands != null)
                            {
                                foreach (var brand in ViewBag.Brands)
                                {
                                    <option value="@brand.brand_id">@brand.brand_name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <select class="form-select" id="modal_product_category" name="category_id" required>
                            @if (ViewBag.Categories != null)
                            {
                                foreach (var category in ViewBag.Categories)
                                {
                                    <option value="@category.category_id">@category.category_name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model Year</label>
                        <input type="number" class="form-control" id="modal_product_year" name="model_year" min="2000" max="2030">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">List Price *</label>
                        <input type="number" class="form-control" id="modal_product_price" name="list_price" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize data
            var staffData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                Model.Staffs.Select(s => new {
                    staff_id = s.staff_id,
                    first_name = s.first_name,
                    last_name = s.last_name,
                    email = s.email,
                    phone = s.phone,
                    active = s.active,
                    store_id = s.store_id,
                    store_name = s.stores != null ? s.stores.store_name : "N/A"
                }).ToList()
            ));

            var customerData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                Model.Customers.Select(c => new {
                    customer_id = c.customer_id,
                    first_name = c.first_name,
                    last_name = c.last_name,
                    email = c.email,
                    phone = c.phone,
                    street = c.street,
                    city = c.city,
                    state = c.state,
                    zip_code = c.zip_code
                }).ToList()
            ));

            var productData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                Model.Products.Select(p => new {
                    product_id = p.product_id,
                    product_name = p.product_name,
                    brand_id = p.brand_id,
                    brand_name = p.brands != null ? p.brands.brand_name : "N/A",
                    category_id = p.category_id,
                    category_name = p.categories != null ? p.categories.category_name : "N/A",
                    model_year = p.model_year,
                    list_price = p.list_price
                }).ToList()
            ));

            var selectedStaffId = null;
            var selectedCustomerId = null;
            var selectedProductId = null;

            // Staff selection
            $('#staffList li').click(function () {
                $('#staffList li').removeClass('selected');
                $(this).addClass('selected');
                selectedStaffId = $(this).data('id');

                var staff = staffData.find(s => s.staff_id === selectedStaffId);
                if (staff) {
                    $('#staff_first').val(staff.first_name);
                    $('#staff_last').val(staff.last_name);
                    $('#staff_id').val(staff.staff_id);
                    $('#staff_email').val(staff.email || '');
                    $('#staff_phone').val(staff.phone || '');
                    $('#staff_store').val(staff.store_name);
                }
            });

            // Customer selection
            $('#customerList li').click(function () {
                $('#customerList li').removeClass('selected');
                $(this).addClass('selected');
                selectedCustomerId = $(this).data('id');

                var customer = customerData.find(c => c.customer_id === selectedCustomerId);
                if (customer) {
                    $('#cust_first').val(customer.first_name);
                    $('#cust_last').val(customer.last_name);
                    $('#cust_id').val(customer.customer_id);
                    $('#cust_email').val(customer.email || '');
                    $('#cust_phone').val(customer.phone || '');
                    $('#cust_city').val(customer.city || '');
                }
            });

            // Product selection
            $('#productList li').click(function () {
                $('#productList li').removeClass('selected');
                $(this).addClass('selected');
                selectedProductId = $(this).data('id');

                var product = productData.find(p => p.product_id === selectedProductId);
                if (product) {
                    $('#product_name').val(product.product_name);
                    $('#product_brand').val(product.brand_name);
                    $('#product_category').val(product.category_name);
                    $('#product_year').val(product.model_year);
                    $('#product_price').val('$' + product.list_price.toFixed(2));
                    loadProductImage(product.product_id, product.brand_name);
                }
            });

            // Load product image
            function loadProductImage(productId, brandName) {
                var extensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
                var imagePaths = [];

                extensions.forEach(function(ext) {
                    imagePaths.push('/Content/Images/' + productId + ext);
                });

                var product = productData.find(p => p.product_id === productId);
                if (product && product.product_name) {
                    var productNameClean = product.product_name.replace(/[^a-zA-Z0-9]/g, '_');
                    extensions.forEach(function(ext) {
                        imagePaths.push('/Content/Images/' + productNameClean + ext);
                    });
                }

                if (brandName) {
                    extensions.forEach(function(ext) {
                        imagePaths.push('/Content/Images/' + brandName.replace(/\s+/g, '_') + ext);
                    });
                }

                extensions.forEach(function(ext) {
                    imagePaths.push('/Content/Images/bicycle' + ext);
                });

                tryLoadImage(imagePaths, 0);
            }

            function tryLoadImage(paths, index) {
                if (index >= paths.length) {
                    $('#productImageContainer').html('<span class="placeholder-text">No image available</span>');
                    return;
                }

                var img = new Image();
                img.onload = function() {
                    $('#productImageContainer').html('<img src="' + paths[index] + '" alt="Product Image" />');
                };
                img.onerror = function() {
                    tryLoadImage(paths, index + 1);
                };
                img.src = paths[index];
            }

            // Edit Staff
            $('#editStaffBtn').click(function() {
                if (!selectedStaffId) {
                    alert('Please select a staff member to edit.');
                    return;
                }

                var staff = staffData.find(s => s.staff_id === selectedStaffId);
                if (staff) {
                    $('#modal_staff_id').val(staff.staff_id);
                    $('#modal_staff_first_name').val(staff.first_name);
                    $('#modal_staff_last_name').val(staff.last_name);
                    $('#modal_staff_email').val(staff.email || '');
                    $('#modal_staff_phone').val(staff.phone || '');
                    $('#modal_staff_active').val(staff.active || '1');
                    $('#modal_staff_store').val(staff.store_id);
                    $('#modal_staff_manager').val(staff.manager_id || '');

                    var staffModal = new bootstrap.Modal(document.getElementById('staffEditModal'));
                    staffModal.show();
                }
            });

            // Edit Customer
            $('#editCustomerBtn').click(function() {
                if (!selectedCustomerId) {
                    alert('Please select a customer to edit.');
                    return;
                }

                var customer = customerData.find(c => c.customer_id === selectedCustomerId);
                if (customer) {
                    $('#modal_customer_id').val(customer.customer_id);
                    $('#modal_customer_first_name').val(customer.first_name);
                    $('#modal_customer_last_name').val(customer.last_name);
                    $('#modal_customer_email').val(customer.email || '');
                    $('#modal_customer_phone').val(customer.phone || '');
                    $('#modal_customer_street').val(customer.street || '');
                    $('#modal_customer_city').val(customer.city || '');
                    $('#modal_customer_state').val(customer.state || '');
                    $('#modal_customer_zip').val(customer.zip_code || '');

                    var customerModal = new bootstrap.Modal(document.getElementById('customerEditModal'));
                    customerModal.show();
                }
            });

            // Edit Product
            $('#editProductBtn').click(function() {
                if (!selectedProductId) {
                    alert('Please select a product to edit.');
                    return;
                }

                var product = productData.find(p => p.product_id === selectedProductId);
                if (product) {
                    $('#modal_product_id').val(product.product_id);
                    $('#modal_product_name').val(product.product_name);
                    $('#modal_product_brand').val(product.brand_id);
                    $('#modal_product_category').val(product.category_id);
                    $('#modal_product_year').val(product.model_year);
                    $('#modal_product_price').val(product.list_price);

                    var productModal = new bootstrap.Modal(document.getElementById('productEditModal'));
                    productModal.show();
                }
            });

            // Delete Staff
            $('#deleteStaffBtn').click(function() {
                if (!selectedStaffId) {
                    alert('Please select a staff member to delete.');
                    return;
                }

                if (confirm('Are you sure you want to delete this staff member?')) {
                    $('<form>')
                        .attr('method', 'post')
                        .attr('action', '@Url.Action("DeleteStaff", "Maintain")')
                        .append($('<input>').attr('type', 'hidden').attr('name', 'staff_id').val(selectedStaffId))
                        .append($('@Html.AntiForgeryToken()'))
                        .appendTo('body')
                        .submit();
                }
            });

            // Delete Customer
            $('#deleteCustomerBtn').click(function() {
                if (!selectedCustomerId) {
                    alert('Please select a customer to delete.');
                    return;
                }

                if (confirm('Are you sure you want to delete this customer?')) {
                    $('<form>')
                        .attr('method', 'post')
                        .attr('action', '@Url.Action("DeleteCustomer", "Maintain")')
                        .append($('<input>').attr('type', 'hidden').attr('name', 'customer_id').val(selectedCustomerId))
                        .append($('@Html.AntiForgeryToken()'))
                        .appendTo('body')
                        .submit();
                }
            });

            // Delete Product
            $('#deleteProductBtn').click(function() {
                if (!selectedProductId) {
                    alert('Please select a product to delete.');
                    return;
                }

                if (confirm('Are you sure you want to delete this product?')) {
                    $('<form>')
                        .attr('method', 'post')
                        .attr('action', '@Url.Action("DeleteProduct", "Maintain")')
                        .append($('<input>').attr('type', 'hidden').attr('name', 'product_id').val(selectedProductId))
                        .append($('@Html.AntiForgeryToken()'))
                        .appendTo('body')
                        .submit();
                }
            });
        });
    </script>
}